# =============================================================================
# ProcGenie S2P Platform - Continuous Deployment
# =============================================================================
# Triggers: push to main (after CI passes)
# Deploys: Docker images to ACR, updates Azure Container Apps
# =============================================================================

name: Deploy

on:
  push:
    branches: [main, 'claude/**']

  workflow_dispatch:
    inputs:
      environment:
        description: "Target environment"
        required: true
        type: choice
        options:
          - dev
          - staging
          - prod
        default: dev

concurrency:
  group: deploy-${{ github.event.inputs.environment || 'dev' }}
  cancel-in-progress: false

env:
  NODE_VERSION: "20"
  AZURE_RESOURCE_GROUP: rg-procgenie-${{ github.event.inputs.environment || 'dev' }}
  ACR_NAME: acrprocgenie${{ github.event.inputs.environment || 'dev' }}
  ACR_LOGIN_SERVER: acrprocgenie${{ github.event.inputs.environment || 'dev' }}.azurecr.io
  IMAGE_TAG: ${{ github.sha }}
  ENVIRONMENT: ${{ github.event.inputs.environment || 'dev' }}
  # Container Apps FQDNs (set during initial Bicep deploy)
  WEB_FQDN: ca-procgenie-${{ github.event.inputs.environment || 'dev' }}-web.happypond-9a781889.westus2.azurecontainerapps.io
  API_FQDN: ca-procgenie-${{ github.event.inputs.environment || 'dev' }}-api.happypond-9a781889.westus2.azurecontainerapps.io

permissions:
  contents: read

jobs:
  # ---------------------------------------------------------------------------
  # Gate: Ensure CI passed
  # ---------------------------------------------------------------------------
  ci-check:
    name: Verify CI Status
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Check CI workflow status
        uses: actions/github-script@v7
        with:
          script: |
            const { data: runs } = await github.rest.actions.listWorkflowRunsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head_sha: context.sha,
              status: 'completed',
            });

            const ciRun = runs.workflow_runs.find(r => r.name === 'CI');
            if (!ciRun) {
              core.info('No CI run found for this commit. Proceeding with deployment.');
              return;
            }
            if (ciRun.conclusion !== 'success') {
              core.setFailed(`CI workflow did not succeed (conclusion: ${ciRun.conclusion}). Aborting deployment.`);
            } else {
              core.info('CI workflow passed. Proceeding with deployment.');
            }

  # ---------------------------------------------------------------------------
  # Build, Push, and Deploy Docker Images
  # ---------------------------------------------------------------------------
  build-and-deploy:
    name: Build, Push & Deploy
    runs-on: ubuntu-latest
    timeout-minutes: 25
    needs: ci-check
    environment:
      name: ${{ github.event.inputs.environment || 'dev' }}
      url: https://${{ env.WEB_FQDN }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Login to ACR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.ACR_LOGIN_SERVER }}
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push web image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: apps/web/Dockerfile
          push: true
          tags: |
            ${{ env.ACR_LOGIN_SERVER }}/procgenie-web:${{ env.IMAGE_TAG }}
            ${{ env.ACR_LOGIN_SERVER }}/procgenie-web:latest
          cache-from: type=gha,scope=web
          cache-to: type=gha,mode=max,scope=web

      - name: Build and push API image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: apps/api/Dockerfile
          push: true
          tags: |
            ${{ env.ACR_LOGIN_SERVER }}/procgenie-api:${{ env.IMAGE_TAG }}
            ${{ env.ACR_LOGIN_SERVER }}/procgenie-api:latest
          cache-from: type=gha,scope=api
          cache-to: type=gha,mode=max,scope=api

      - name: Trigger Container Apps revision update
        run: |
          echo "Images pushed to ACR with :latest tag."
          echo "Container Apps are configured to pull latest images."
          echo ""
          echo "Web image: ${{ env.ACR_LOGIN_SERVER }}/procgenie-web:${{ env.IMAGE_TAG }}"
          echo "API image: ${{ env.ACR_LOGIN_SERVER }}/procgenie-api:${{ env.IMAGE_TAG }}"
          echo ""
          echo "If Container Apps don't auto-update, run locally:"
          echo "  az containerapp update --name ca-procgenie-${{ env.ENVIRONMENT }}-web --resource-group ${{ env.AZURE_RESOURCE_GROUP }} --image ${{ env.ACR_LOGIN_SERVER }}/procgenie-web:${{ env.IMAGE_TAG }}"
          echo "  az containerapp update --name ca-procgenie-${{ env.ENVIRONMENT }}-api --resource-group ${{ env.AZURE_RESOURCE_GROUP }} --image ${{ env.ACR_LOGIN_SERVER }}/procgenie-api:${{ env.IMAGE_TAG }}"

  # ---------------------------------------------------------------------------
  # Smoke Tests
  # ---------------------------------------------------------------------------
  smoke-tests:
    name: Smoke Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: build-and-deploy

    steps:
      - name: Wait for containers to pull new images
        run: sleep 60

      - name: Smoke test - Web app
        run: |
          WEB_URL="https://${{ env.WEB_FQDN }}"
          echo "Testing web app at ${WEB_URL}"
          for i in 1 2 3 4 5; do
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" "${WEB_URL}" --max-time 30 || echo "000")
            echo "Attempt ${i}: HTTP ${STATUS}"
            if [ "${STATUS}" = "200" ]; then
              echo "Web app is healthy"
              exit 0
            fi
            sleep 15
          done
          echo "::warning::Web app smoke test failed (may still be starting)"

      - name: Smoke test - API health
        run: |
          API_URL="https://${{ env.API_FQDN }}/api/v1/health"
          echo "Testing API health at ${API_URL}"
          for i in 1 2 3 4 5; do
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" "${API_URL}" --max-time 30 || echo "000")
            echo "Attempt ${i}: HTTP ${STATUS}"
            if [ "${STATUS}" = "200" ]; then
              echo "API is healthy"
              exit 0
            fi
            sleep 15
          done
          echo "::warning::API smoke test failed (may still be starting)"

      - name: Smoke test - API response validation
        run: |
          API_URL="https://${{ env.API_FQDN }}/api/v1/health"
          RESPONSE=$(curl -s "${API_URL}" --max-time 30 || echo '{}')
          echo "Health response: ${RESPONSE}"
          echo "${RESPONSE}" | jq -e '.status' > /dev/null 2>&1 || \
            echo "::warning::Health endpoint did not return expected JSON format"
        continue-on-error: true

  # ---------------------------------------------------------------------------
  # Post-Deployment Notification
  # ---------------------------------------------------------------------------
  notify:
    name: Notify
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [build-and-deploy, smoke-tests]
    if: always()

    steps:
      - name: Deployment summary
        run: |
          DEPLOY_STATUS="${{ needs.build-and-deploy.result }}"
          SMOKE_STATUS="${{ needs.smoke-tests.result }}"

          echo "## Deployment Summary" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Property | Value |" >> "$GITHUB_STEP_SUMMARY"
          echo "|----------|-------|" >> "$GITHUB_STEP_SUMMARY"
          echo "| Environment | \`${{ env.ENVIRONMENT }}\` |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Image Tag | \`${{ env.IMAGE_TAG }}\` |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Commit | \`${{ github.sha }}\` |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Deploy Status | ${DEPLOY_STATUS} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Smoke Tests | ${SMOKE_STATUS} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Web URL | https://${{ env.WEB_FQDN }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| API URL | https://${{ env.API_FQDN }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Triggered By | @${{ github.actor }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Workflow Run | [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) |" >> "$GITHUB_STEP_SUMMARY"

      - name: Post to Slack (if configured)
        if: env.SLACK_WEBHOOK_URL != ''
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          DEPLOY_STATUS="${{ needs.build-and-deploy.result }}"
          EMOJI=$([[ "${DEPLOY_STATUS}" == "success" ]] && echo ":white_check_mark:" || echo ":x:")

          curl -s -X POST "${SLACK_WEBHOOK_URL}" \
            -H 'Content-type: application/json' \
            -d @- <<PAYLOAD
          {
            "blocks": [
              {
                "type": "header",
                "text": {
                  "type": "plain_text",
                  "text": "${EMOJI} ProcGenie Deployment - ${{ env.ENVIRONMENT }}"
                }
              },
              {
                "type": "section",
                "fields": [
                  { "type": "mrkdwn", "text": "*Status:*\n${DEPLOY_STATUS}" },
                  { "type": "mrkdwn", "text": "*Environment:*\n${{ env.ENVIRONMENT }}" },
                  { "type": "mrkdwn", "text": "*Commit:*\n\`${{ github.sha }}\`" },
                  { "type": "mrkdwn", "text": "*Triggered by:*\n@${{ github.actor }}" }
                ]
              },
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "<https://${{ env.WEB_FQDN }}|Web App> | <https://${{ env.API_FQDN }}/api/v1/health|API Health> | <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|Workflow Run>"
                }
              }
            ]
          }
          PAYLOAD
        continue-on-error: true
